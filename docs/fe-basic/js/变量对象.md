# 变量对象

变量对象 ( `Variable object`，`VO` ) 是与执行上下文相关的数据作用域，存储了在上下文中定义的 **变量** 和 **函数声明** 。

不同执行上下文下的变量对象稍有不同，下面我们来聊聊全局执行上下文中的变量对象和函数执行上下文中的变量对象。

:::tip
在函数执行上下文中，参数列表也会被加入到变量对象中存储。
:::

## 全局执行上下文中的变量对象

在全局执行上下文中，变量对象就是全局对象，放到浏览器中，就是指 `window` 。  
这里就不多做介绍了。

## 函数执行上下文中的变量对象

在函数执行上下文中，变量对象用活动对象（ `Activation Object`，`AO` ）来表示。

活动对象和变量对象主要区别如下：

- 变量对象是规范上或者是引擎实现上的，无法在 `JS` 环境中直接访问。
- 只有当进入到一个执行上下文后，这个变量对象才会被激活，因而被叫做活动对象。这时活动对象上的各种属性才能被访问。

活动对象是在进入函数执行上下文的时刻被创建的，它通过函数的 `arguments` 属性初始化。
`arguments` 属性值是 `Arguments` 对象，所有作为函数参数传入的值都会成为 `Arguments` 对象的数组元素。

## 处理执行上下文的过程

进入执行上下文的代码会分成两个阶段来处理：

- 进入执行上下文（创建阶段）
- 代码执行（执行阶段）

下面我们依次分析这两阶段变量对象的变化。

### 进入执行上下文

刚进入执行上下文的时候，这时还没有执行代码。此时的变量对象会包括（如下顺序初始化）：

- 函数形参（仅限函数执行上下文）：如果没有实参，属性值设为 `undefined` 。
- 函数声明：如果变量对象已经存在相同名称的属性，则完全 **替换** 这个属性。
- 变量声明：如果变量名称跟已经声明的形参或函数相同，则变量声明 **不会干扰** 已经存在的这类属性。

举个栗子

```
function foo(a) {
  var b = 2
  function c() {}
  var d = function() {}

  b = 3
}

foo(1)
```

刚进入执行上下文时的 `AO` 如下

```
AO = {
  arguments: {
    0: 1,
    length: 1
  },
  a: 1,
  b: undefined,
  c: reference to function c() {},
  d: undefined
}
```

可见，在该阶段，形参 `arguments` 已经有赋值了，但变量还是 `undefined` ，只是初始化的值。

### 代码执行

在代码执行阶段，会顺序执行代码，根据代码，修改变量对象的值。  
代码执行完时的 `AO` 如下

```
AO = {
  arguments: {
    0: 1,
    length: 1
  },
  a: 1,
  b: 3,
  c: reference to function c(){},
  d: reference to FunctionExpression "d"
}
```

到这里变量对象的创建过程就介绍完了，让我们简洁的总结我们上述所说：

- 全局执行上下文的变量对象初始化是全局对象
- 函数执行上下文的变量对象初始化只包括 `Arguments` 对象
- 进入执行上下文时，会给变量对象添加 **形参、函数声明、变量声明** 等初始的属性值
- 代码执行时，会再次修改变量对象的属性值

## 参考

- [JavaScript 深入之变量对象](https://github.com/mqyqingfeng/Blog/issues/5)
  